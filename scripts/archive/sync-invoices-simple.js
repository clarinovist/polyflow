const { PrismaClient, JournalStatus, ReferenceType } = require('@prisma/client');
const prisma = new PrismaClient();

async function getAccountByCode(code) {
    const account = await prisma.account.findUnique({ where: { code } });
    if (!account) throw new Error(`Account code ${code} not found.`);
    return account;
}

async function generateEntryNumber(date) {
    const year = date.getFullYear();
    const key = `JOURNAL_ENTRY_${year}`;

    try {
        const sequence = await prisma.systemSequence.update({
            where: { key },
            data: { value: { increment: 1n } }
        });
        const currentVal = Number(sequence.value) - 1;
        return `JE - ${year} -${currentVal.toString().padStart(5, '0')}`;
    } catch (error) {
        if (error.code === 'P2025') {
            const latestEntry = await prisma.journalEntry.findFirst({
                where: {
                    entryDate: {
                        gte: new Date(year, 0, 1),
                        lt: new Date(year + 1, 0, 1)
                    }
                },
                orderBy: { entryNumber: 'desc' }
            });

            let startValue = 1;
            if (latestEntry && latestEntry.entryNumber) {
                const parts = latestEntry.entryNumber.split('-');
                const lastPart = parts[parts.length - 1].trim();
                const lastNum = parseInt(lastPart, 10);
                if (!isNaN(lastNum)) {
                    startValue = lastNum + 1;
                }
            }

            const sequence = await prisma.systemSequence.upsert({
                where: { key },
                update: { value: { increment: 1n } },
                create: { key, value: BigInt(startValue + 1) }
            });
            const currentVal = Number(sequence.value) - 1;
            return `JE - ${year} -${currentVal.toString().padStart(5, '0')}`;
        }
        throw error;
    }
}

async function handleSalesInvoiceCreated(invoiceId) {
    const invoice = await prisma.invoice.findUnique({
        where: { id: invoiceId },
        include: { salesOrder: true }
    });

    if (!invoice) throw new Error(`Invoice ${invoiceId} not found`);

    const AR_ACCOUNT = '11210';
    const REVENUE_ACCOUNT = '41100';
    const VAT_OUT_ACCOUNT = '21310';

    const arAccount = await getAccountByCode(AR_ACCOUNT);
    const revenueAccount = await getAccountByCode(REVENUE_ACCOUNT);
    const vatAccount = await getAccountByCode(VAT_OUT_ACCOUNT);

    const totalAmount = Number(invoice.totalAmount);
    const soTotal = Number(invoice.salesOrder.totalAmount || 0);
    const soTax = Number(invoice.salesOrder.taxAmount || 0);

    let taxAmount = 0;
    if (soTotal > 0 && soTax > 0) {
        const taxRate = soTax / (soTotal - soTax);
        const netAmount = totalAmount / (1 + taxRate);
        taxAmount = totalAmount - netAmount;
    }

    const subtotal = totalAmount - taxAmount;
    const entryNumber = await generateEntryNumber(invoice.invoiceDate);

    await prisma.journalEntry.create({
        data: {
            entryNumber,
            entryDate: invoice.invoiceDate,
            description: `Sales Invoice #${invoice.invoiceNumber}`,
            reference: invoice.invoiceNumber,
            referenceType: 'SALES_INVOICE',
            referenceId: invoice.id,
            isAutoGenerated: true,
            status: 'POSTED', // Auto-post for sync
            lines: {
                create: [
                    { accountId: arAccount.id, debit: totalAmount, credit: 0, description: `AR for ${invoice.invoiceNumber}` },
                    { accountId: revenueAccount.id, debit: 0, credit: subtotal, description: `Revenue for ${invoice.invoiceNumber}` },
                    { accountId: vatAccount.id, debit: 0, credit: taxAmount, description: `VAT Output for ${invoice.invoiceNumber}` }
                ]
            }
        }
    });

    console.log(`[SYNC] Created journal for Invoice ${invoice.invoiceNumber}`);
}

async function run() {
    const invoices = await prisma.invoice.findMany();
    for (const inv of invoices) {
        const je = await prisma.journalEntry.findFirst({ where: { referenceId: inv.id } });
        if (!je) {
            console.log(`[SYNC] Processing ${inv.invoiceNumber}...`);
            await handleSalesInvoiceCreated(inv.id);
        }
    }
    console.log('[SYNC] Done.');
}

run().catch(console.error).finally(() => prisma.$disconnect());
