
const { PrismaClient } = require('@prisma/client');
/**
 * PRODUCTION MIGRATION SCRIPT
 * Purpose: Fix incorrect account mappings in historical Journal Entries.
 * Re-maps codes from 12xxx (Machinery) to 113xx (Inventory).
 */
async function migrate() {
    const prisma = new PrismaClient();

    const mapping = {
        '12100': '11310', // Raw Materials
        '12300': '11350', // Scrap
        '12400': '11320', // WIP
        '12500': '11330', // Finished Goods
        '12600': '11340', // Packaging
    };

    try {
        console.log('--- Starting Migration ---');

        // 1. Fetch Target Accounts
        const targetCodes = Object.values(mapping);
        const targetAccounts = await prisma.account.findMany({
            where: { code: { in: targetCodes } }
        });

        const accountMap = {};
        targetAccounts.forEach(acc => {
            accountMap[acc.code] = acc.id;
        });

        // 2. Validate Target Accounts Exist
        for (const [oldCode, newCode] of Object.entries(mapping)) {
            if (!accountMap[newCode]) {
                console.error(`ERROR: Target account ${newCode} not found in Chart of Accounts.`);
                process.exit(1);
            }
        }

        // 3. Find Affected Lines
        const linesToUpdate = await prisma.journalLine.findMany({
            where: {
                account: { code: { in: Object.keys(mapping) } },
                journalEntry: { isAutoGenerated: true }
            },
            include: { account: true }
        });

        console.log(`Found ${linesToUpdate.length} lines to migrate.`);

        if (linesToUpdate.length === 0) {
            console.log('No historical data requires migration.');
            return;
        }

        // 4. Atomic Update
        const result = await prisma.$transaction(async (tx) => {
            let count = 0;
            for (const line of linesToUpdate) {
                const newCode = mapping[line.account.code];
                const newAccountId = accountMap[newCode];

                await tx.journalLine.update({
                    where: { id: line.id },
                    data: { accountId: newAccountId }
                });
                count++;
            }
            return count;
        });

        console.log(`SUCCESS: Updated ${result} journal lines.`);
        console.log('--- Migration Completed ---');

    } catch (error) {
        console.error('FATAL ERROR DURING MIGRATION:', error);
        process.exit(1);
    } finally {
        await prisma.$disconnect();
    }
}

migrate();
