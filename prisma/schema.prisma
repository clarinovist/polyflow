generator client {
  provider      = "prisma-client-js"
  binaryTargets = ["native", "linux-musl-openssl-3.0.x"]
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id                 String              @id @default(uuid())
  email              String              @unique
  name               String?
  password           String
  role               Role                @default(WAREHOUSE)
  createdAt          DateTime            @default(now())
  updatedAt          DateTime            @updatedAt
  materialIssues     MaterialIssue[]
  productionCreator  ProductionOrder[]   @relation("ProductionCreator")
  inspections        QualityInspection[]
  scrapRecords       ScrapRecord[]
  movements          StockMovement[]
  opnames            StockOpname[]
  auditLogs          AuditLog[]
  downtimeLogs       MachineDowntime[]
  salesOrders        SalesOrder[]        @relation("SalesCreator")
  quotations         SalesQuotation[]    @relation("QuotationCreator")
  purchaseOrders     PurchaseOrder[]     @relation("PurchaseCreator")
  goodsReceipts      GoodsReceipt[]      @relation("GoodsReceiptCreator")
  purchasePayments   PurchasePayment[]   @relation("PaymentCreator")
  createdJournals    JournalEntry[]      @relation("JournalCreator")
  approvedJournals   JournalEntry[]      @relation("JournalApprover")
}

model Employee {
  id        String         @id @default(uuid())
  name      String
  code      String         @unique
  role      String
  status    EmployeeStatus @default(ACTIVE)
  hourlyRate Decimal       @default(0) @db.Decimal(10, 2)
  createdAt DateTime       @default(now())
  updatedAt DateTime       @updatedAt

  shiftsAsOperator ProductionShift[]     @relation("ShiftOperator")
  shiftsAsHelper   ProductionShift[]     @relation("ShiftHelpers")
  executionsAsOperator ProductionExecution[] @relation("ExecutionOperator")
}

model ProductionShift {
  id                String          @id @default(uuid())
  productionOrderId String
  shiftName         String
  startTime         DateTime
  endTime           DateTime
  operatorId        String?
  outputQuantity    Decimal?        @db.Decimal(15, 4)
  notes             String?
  createdAt         DateTime        @default(now())
  updatedAt         DateTime        @updatedAt

  productionOrder ProductionOrder @relation(fields: [productionOrderId], references: [id])
  operator        Employee?       @relation("ShiftOperator", fields: [operatorId], references: [id])
  helpers         Employee[]      @relation("ShiftHelpers")
}


model Supplier {
  id               String            @id @default(uuid())
  name             String
  code             String?           @unique
  phone            String?
  email            String?
  address          String?
  taxId            String?
  paymentTermDays  Int?
  bankName         String?
  bankAccount      String?
  notes            String?
  isActive         Boolean           @default(true)
  createdAt        DateTime          @default(now())
  updatedAt        DateTime          @updatedAt

  supplierProducts SupplierProduct[]
  productVariants  ProductVariant[]  @relation("PreferredSupplier")
  purchaseOrders   PurchaseOrder[]
}

model Customer {
  id              String   @id @default(uuid())
  name            String
  code            String?  @unique
  phone           String?
  email           String?
  billingAddress  String?
  shippingAddress String?
  taxId           String?
  creditLimit     Decimal? @db.Decimal(15, 2)
  paymentTermDays Int?
  discountPercent Decimal? @db.Decimal(5, 2)
  notes           String?
  isActive        Boolean  @default(true)
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  salesOrders     SalesOrder[]
  quotations      SalesQuotation[]
}

// Contact model removed

model Location {
  id               String             @id @default(uuid())
  name             String
  slug             String             @unique
  description      String?
  createdAt        DateTime           @default(now())
  updatedAt        DateTime           @updatedAt
  Batch            Batch[]
  inventories      Inventory[]
  machines         Machine[]
  ProductionOrder  ProductionOrder[]
  movementsFrom    StockMovement[]    @relation("FromLocation")
  movementsTo      StockMovement[]    @relation("ToLocation")
  opnames          StockOpname[]
  StockReservation StockReservation[]
  salesOrders      SalesOrder[]       @relation("SalesSourceLocation")
  goodsReceipts    GoodsReceipt[]
  fixedAssets      FixedAsset[]
}

model Product {
  id                 String           @id @default(uuid())
  name               String
  productType        ProductType
  createdAt          DateTime         @default(now())
  updatedAt          DateTime         @updatedAt
  variants           ProductVariant[]
  
  // Accounting Mappings
  wipAccountId       String?
  inventoryAccountId String?
  cogsAccountId      String?
  revenueAccountId   String?
}

model ProductVariant {
  id                  String             @id @default(uuid())
  productId           String
  name                String
  skuCode             String             @unique
  price               Decimal?           @db.Decimal(10, 2)
  buyPrice            Decimal?           @db.Decimal(10, 2)
  sellPrice           Decimal?           @db.Decimal(10, 2)
  primaryUnit         Unit
  salesUnit           Unit?
  conversionFactor    Decimal            @default(1.0) @db.Decimal(10, 4)
  attributes          Json?
  createdAt           DateTime           @default(now())
  updatedAt           DateTime           @updatedAt
  costingMethod       CostingMethod      @default(WEIGHTED_AVERAGE)
  standardCost        Decimal?           @db.Decimal(15, 4)
  minStockAlert       Decimal?           @db.Decimal(15, 4)
  leadTimeDays        Int?
  preferredSupplierId String?
  reorderPoint        Decimal?           @db.Decimal(15, 4)
  reorderQuantity     Decimal?           @db.Decimal(15, 4)
  Batch               Batch[]
  productionBoms      Bom[]              @relation("ProductBom")
  ingredientInBoms    BomItem[]          @relation("Ingredient")
  inventories         Inventory[]
  productionMaterials ProductionMaterial[]
  MaterialIssue       MaterialIssue[]
  preferredSupplier   Supplier?          @relation("PreferredSupplier", fields: [preferredSupplierId], references: [id])
  supplierProducts    SupplierProduct[]
  product             Product            @relation(fields: [productId], references: [id])
  ScrapRecord         ScrapRecord[]
  movements           StockMovement[]
  opnameItems         StockOpnameItem[]
  StockReservation    StockReservation[]
  salesOrderItems     SalesOrderItem[]
  quotationItems      SalesQuotationItem[]
  purchaseOrderItems  PurchaseOrderItem[]
  goodsReceiptItems   GoodsReceiptItem[]
}

model SupplierProduct {
  id               String         @id @default(uuid())
  supplierId       String
  productVariantId String
  unitPrice        Decimal?       @db.Decimal(15, 4)
  leadTimeDays     Int?
  minOrderQty      Decimal?       @db.Decimal(15, 4)
  isPreferred      Boolean        @default(false)
  notes            String?
  createdAt        DateTime       @default(now())
  updatedAt        DateTime       @updatedAt

  supplier       Supplier       @relation(fields: [supplierId], references: [id])
  productVariant ProductVariant @relation(fields: [productVariantId], references: [id])

  @@unique([supplierId, productVariantId])
}

model Bom {
  id               String            @id @default(uuid())
  name             String
  description      String?
  productVariantId String
  outputQuantity   Decimal           @default(1.0) @db.Decimal(10, 4)
  isDefault        Boolean           @default(false)
  createdAt        DateTime          @default(now())
  updatedAt        DateTime          @updatedAt
  productVariant   ProductVariant    @relation("ProductBom", fields: [productVariantId], references: [id])
  items            BomItem[]
  ProductionOrder  ProductionOrder[]
}

model BomItem {
  id               String         @id @default(uuid())
  bomId            String
  productVariantId String
  quantity         Decimal        @db.Decimal(10, 4)
  scrapPercentage  Decimal?       @db.Decimal(5, 2)
  createdAt        DateTime       @default(now())
  updatedAt        DateTime       @updatedAt
  bom              Bom            @relation(fields: [bomId], references: [id], onDelete: Cascade)
  productVariant   ProductVariant @relation("Ingredient", fields: [productVariantId], references: [id])
}

model StockMovement {
  id               String         @id @default(uuid())
  type             MovementType
  productVariantId String
  fromLocationId   String?
  toLocationId     String?
  quantity         Decimal        @db.Decimal(15, 4)
  cost             Decimal?       @db.Decimal(15, 4)
  reference        String?
  createdById      String?
  createdAt        DateTime       @default(now())
  batchId          String?
  batch            Batch?         @relation(fields: [batchId], references: [id])
  createdBy        User?          @relation(fields: [createdById], references: [id])
  fromLocation     Location?      @relation("FromLocation", fields: [fromLocationId], references: [id])
  productVariant   ProductVariant @relation(fields: [productVariantId], references: [id])
  toLocation       Location?      @relation("ToLocation", fields: [toLocationId], references: [id])
  salesOrderId     String?
  salesOrder       SalesOrder?    @relation("SalesMovement", fields: [salesOrderId], references: [id])
  goodsReceiptId   String?
  goodsReceipt     GoodsReceipt?  @relation("GoodsReceiptMovement", fields: [goodsReceiptId], references: [id])
}

model Inventory {
  id               String         @id @default(uuid())
  locationId       String
  productVariantId String
  quantity         Decimal        @default(0) @db.Decimal(15, 4)
  averageCost      Decimal?       @db.Decimal(15, 4)
  updatedAt        DateTime       @updatedAt
  location         Location       @relation(fields: [locationId], references: [id])
  productVariant   ProductVariant @relation(fields: [productVariantId], references: [id])

  @@unique([locationId, productVariantId])
}

model Machine {
  id              String            @id @default(uuid())
  name            String
  code            String            @unique
  type            MachineType
  locationId      String
  status          MachineStatus     @default(ACTIVE)
  costPerHour     Decimal           @default(0) @db.Decimal(10, 2)
  createdAt       DateTime          @default(now())
  updatedAt       DateTime          @updatedAt
  location        Location          @relation(fields: [locationId], references: [id])
  ProductionOrder ProductionOrder[]
  executions      ProductionExecution[]
  downtimeLogs    MachineDowntime[]
}

model Batch {
  id                String          @id @default(uuid())
  batchNumber       String          @unique
  productVariantId  String
  locationId        String
  quantity          Decimal         @db.Decimal(15, 4)
  manufacturingDate DateTime
  expiryDate        DateTime?
  status            BatchStatus     @default(ACTIVE)
  createdAt         DateTime        @default(now())
  updatedAt         DateTime        @updatedAt
  location          Location        @relation(fields: [locationId], references: [id])
  productVariant    ProductVariant  @relation(fields: [productVariantId], references: [id])
  movements         StockMovement[]
  materialIssues    MaterialIssue[]
}

model StockReservation {
  id               String            @id @default(uuid())
  productVariantId String
  locationId       String
  quantity         Decimal           @db.Decimal(15, 4)
  reservedFor      ReservationType
  referenceId      String
  reservedUntil    DateTime?
  status           ReservationStatus @default(ACTIVE)
  createdAt        DateTime          @default(now())
  updatedAt        DateTime          @updatedAt
  location         Location          @relation(fields: [locationId], references: [id])
  productVariant   ProductVariant    @relation(fields: [productVariantId], references: [id])
}

model StockOpname {
  id          String            @id @default(uuid())
  locationId  String
  status      OpnameStatus      @default(OPEN)
  remarks     String?
  createdById String?
  createdAt   DateTime          @default(now())
  completedAt DateTime?
  updatedAt   DateTime          @updatedAt
  createdBy   User?             @relation(fields: [createdById], references: [id])
  location    Location          @relation(fields: [locationId], references: [id])
  items       StockOpnameItem[]
}

model StockOpnameItem {
  id               String         @id @default(uuid())
  opnameId         String
  productVariantId String
  systemQuantity   Decimal        @db.Decimal(15, 4)
  countedQuantity  Decimal?       @db.Decimal(15, 4)
  notes            String?
  opname           StockOpname    @relation(fields: [opnameId], references: [id])
  productVariant   ProductVariant @relation(fields: [productVariantId], references: [id])

  @@unique([opnameId, productVariantId])
}

model ProductionOrder {
  id               String              @id @default(uuid())
  orderNumber      String              @unique
  bomId            String
  plannedQuantity  Decimal             @db.Decimal(15, 4)
  plannedStartDate DateTime
  plannedEndDate   DateTime?
  actualQuantity   Decimal?            @db.Decimal(15, 4)
  actualStartDate  DateTime?
  actualEndDate    DateTime?
  status           ProductionStatus    @default(DRAFT)
  machineId        String?
  locationId               String
  estimatedConversionCost  Decimal?            @db.Decimal(15, 2)
  createdById              String?
  createdAt        DateTime            @default(now())
  updatedAt        DateTime            @updatedAt
  notes            String?
  materialIssues   MaterialIssue[]
  bom              Bom                 @relation(fields: [bomId], references: [id])
  createdBy        User?               @relation("ProductionCreator", fields: [createdById], references: [id])
  location         Location            @relation(fields: [locationId], references: [id])
  machine          Machine?            @relation(fields: [machineId], references: [id])
  inspections      QualityInspection[]
  scrapRecords     ScrapRecord[]
  shifts           ProductionShift[]
  plannedMaterials ProductionMaterial[]
  executions       ProductionExecution[]
  salesOrderId     String?
  salesOrder       SalesOrder?         @relation("SalesProduction", fields: [salesOrderId], references: [id])
}

model MachineDowntime {
  id          String    @id @default(uuid())
  machineId   String
  machine     Machine   @relation(fields: [machineId], references: [id])
  reason      String
  startTime   DateTime
  endTime     DateTime?
  createdById String?
  createdBy   User?     @relation(fields: [createdById], references: [id])
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  @@index([machineId])
}

model MaterialIssue {
  id                String          @id @default(uuid())
  productionOrderId String
  productVariantId  String
  quantity          Decimal         @db.Decimal(15, 4)
  issuedAt          DateTime        @default(now())
  createdById       String?
  batchId           String?
  createdBy         User?           @relation(fields: [createdById], references: [id])
  batch             Batch?          @relation(fields: [batchId], references: [id])
  productVariant    ProductVariant  @relation(fields: [productVariantId], references: [id])
  productionOrder   ProductionOrder @relation(fields: [productionOrderId], references: [id])
}

model ScrapRecord {
  id                String          @id @default(uuid())
  productionOrderId String
  productVariantId  String
  quantity          Decimal         @db.Decimal(15, 4)
  reason            String?
  recordedAt        DateTime        @default(now())
  createdById       String?
  createdBy         User?           @relation(fields: [createdById], references: [id])
  productVariant    ProductVariant  @relation(fields: [productVariantId], references: [id])
  productionOrder   ProductionOrder @relation(fields: [productionOrderId], references: [id])
}

model QualityInspection {
  id                String           @id @default(uuid())
  productionOrderId String
  inspectorId       String?
  result            InspectionResult
  notes             String?
  inspectedAt       DateTime         @default(now())
  inspector         User?            @relation(fields: [inspectorId], references: [id])
  productionOrder   ProductionOrder  @relation(fields: [productionOrderId], references: [id])
}

enum Role {
  ADMIN
  WAREHOUSE
  PRODUCTION
  PPIC
  SALES
  FINANCE
  PROCUREMENT
}

enum ProductType {
  RAW_MATERIAL
  INTERMEDIATE
  PACKAGING
  WIP
  FINISHED_GOOD
  SCRAP
}

// ContactType enum removed

enum Unit {
  KG
  ROLL
  BAL
  PCS
  ZAK
}

enum MovementType {
  IN
  OUT
  TRANSFER
  ADJUSTMENT
  PURCHASE
}

enum MachineType {
  MIXER
  EXTRUDER
  REWINDER
  PACKER
  GRANULATOR
}

enum MachineStatus {
  ACTIVE
  MAINTENANCE
  BROKEN
}

enum OpnameStatus {
  OPEN
  COMPLETED
  CANCELLED
}

enum BatchStatus {
  ACTIVE
  QUARANTINE
  EXPIRED
  CONSUMED
}

enum ReservationType {
  SALES_ORDER
  PRODUCTION_ORDER
  TRANSFER_ORDER
}

enum ReservationStatus {
  ACTIVE
  FULFILLED
  CANCELLED
  EXPIRED
}

enum ProductionStatus {
  DRAFT
  WAITING_MATERIAL
  RELEASED
  IN_PROGRESS
  COMPLETED
  CANCELLED
}

enum InspectionResult {
  PASS
  FAIL
  QUARANTINE
}




enum CostingMethod {
  WEIGHTED_AVERAGE
  STANDARD_COST
}

enum EmployeeStatus {
  ACTIVE
  INACTIVE
}

model ProductionMaterial {
  id                String          @id @default(uuid())
  productionOrderId String
  productionOrder   ProductionOrder @relation(fields: [productionOrderId], references: [id], onDelete: Cascade)
  productVariantId  String
  productVariant    ProductVariant  @relation(fields: [productVariantId], references: [id])
  quantity          Decimal         @db.Decimal(15, 4)
  createdAt         DateTime        @default(now())
  updatedAt         DateTime        @updatedAt

  @@index([productionOrderId])
  @@index([productVariantId])
}


model ProductionExecution {
  id                String          @id @default(uuid())
  productionOrderId String
  productionOrder   ProductionOrder @relation(fields: [productionOrderId], references: [id], onDelete: Cascade)
  machineId         String?
  machine           Machine?        @relation(fields: [machineId], references: [id])
  operatorId        String?
  operator          Employee?       @relation("ExecutionOperator", fields: [operatorId], references: [id])
  shiftId           String?
  shift             WorkShift?      @relation(fields: [shiftId], references: [id])
  quantityProduced  Decimal         @db.Decimal(15, 4)
  scrapQuantity     Decimal         @default(0) @db.Decimal(15, 4)
  startTime         DateTime
  endTime           DateTime?
  notes             String?
  createdAt         DateTime        @default(now())
  updatedAt         DateTime        @updatedAt

  @@index([productionOrderId])
}

model WorkShift {
  id                   String                @id @default(uuid())
  name                 String
  startTime            String                // Format: "HH:mm"
  endTime              String                // Format: "HH:mm"
  status               WorkShiftStatus       @default(ACTIVE)
  createdAt            DateTime              @default(now())
  updatedAt            DateTime              @updatedAt
  productionExecutions ProductionExecution[]
}

enum WorkShiftStatus {
  ACTIVE
  INACTIVE
}

model JobRole {
  id        String   @id @default(uuid())
  name      String   @unique
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model RolePermission {
  id        String   @id @default(uuid())
  role      Role
  resource  String
  canAccess Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([role, resource])
}

model AuditLog {
  id         String   @id @default(uuid())
  userId     String
  action     String
  entityType String
  entityId   String
  details    String?
  changes    Json?
  createdAt  DateTime @default(now())

  user       User     @relation(fields: [userId], references: [id])
}

// ============================================
// SALES ORDER & INVOICE MODELS
// ============================================

model SalesOrder {
  id               String            @id @default(uuid())
  orderNumber      String            @unique
  customerId       String?
  orderDate        DateTime          @default(now())
  expectedDate     DateTime?
  orderType        SalesOrderType    @default(MAKE_TO_STOCK)
  status           SalesOrderStatus  @default(DRAFT)
  sourceLocationId String?
  totalAmount      Decimal?          @db.Decimal(15, 2)
  discountAmount   Decimal?          @db.Decimal(15, 2)
  taxAmount        Decimal?          @db.Decimal(15, 2)
  notes            String?
  createdById      String?
  createdAt        DateTime          @default(now())
  updatedAt        DateTime          @updatedAt

  customer         Customer?         @relation(fields: [customerId], references: [id])
  sourceLocation   Location?         @relation("SalesSourceLocation", fields: [sourceLocationId], references: [id])
  createdBy        User?             @relation("SalesCreator", fields: [createdById], references: [id])
  items            SalesOrderItem[]
  invoices         Invoice[]
  movements        StockMovement[]   @relation("SalesMovement")
  productionOrders ProductionOrder[] @relation("SalesProduction")
  
  quotationId      String?
  quotation        SalesQuotation?   @relation(fields: [quotationId], references: [id])
}

model SalesQuotation {
  id              String                @id @default(uuid())
  quotationNumber String                @unique
  customerId      String?
  quotationDate   DateTime              @default(now())
  validUntil      DateTime?
  status          SalesQuotationStatus  @default(DRAFT)
  totalAmount     Decimal?              @db.Decimal(15, 2)
  discountAmount  Decimal?              @db.Decimal(15, 2)
  taxAmount       Decimal?              @db.Decimal(15, 2)
  notes           String?
  createdById     String?
  createdAt       DateTime              @default(now())
  updatedAt       DateTime              @updatedAt

  customer        Customer?             @relation(fields: [customerId], references: [id])
  createdBy       User?                 @relation("QuotationCreator", fields: [createdById], references: [id])
  items           SalesQuotationItem[]
  salesOrders     SalesOrder[]
}

model SalesQuotationItem {
  id               String         @id @default(uuid())
  salesQuotationId String
  productVariantId String
  quantity         Decimal        @db.Decimal(15, 4)
  unitPrice        Decimal        @db.Decimal(15, 2)
  discountPercent  Decimal?       @db.Decimal(5, 2)
  taxPercent       Decimal?       @db.Decimal(5, 2)
  taxAmount        Decimal?       @db.Decimal(15, 2)
  subtotal         Decimal        @db.Decimal(15, 2)
  createdAt        DateTime       @default(now())
  updatedAt        DateTime       @updatedAt

  salesQuotation   SalesQuotation @relation(fields: [salesQuotationId], references: [id], onDelete: Cascade)
  productVariant   ProductVariant @relation(fields: [productVariantId], references: [id])
}

enum SalesQuotationStatus {
  DRAFT
  SENT
  ACCEPTED
  REJECTED
  EXPIRED
  CONVERTED
}


model SalesOrderItem {
  id               String         @id @default(uuid())
  salesOrderId     String
  productVariantId String
  quantity         Decimal        @db.Decimal(15, 4)
  unitPrice        Decimal        @db.Decimal(15, 2)
  discountPercent  Decimal?       @db.Decimal(5, 2)
  taxPercent       Decimal?       @db.Decimal(5, 2)
  taxAmount        Decimal?       @db.Decimal(15, 2)
  subtotal         Decimal        @db.Decimal(15, 2)
  deliveredQty     Decimal        @default(0) @db.Decimal(15, 4)
  createdAt        DateTime       @default(now())
  updatedAt        DateTime       @updatedAt

  salesOrder       SalesOrder     @relation(fields: [salesOrderId], references: [id], onDelete: Cascade)
  productVariant   ProductVariant @relation(fields: [productVariantId], references: [id])

  @@index([salesOrderId])
}

model Invoice {
  id            String        @id @default(uuid())
  invoiceNumber String        @unique
  salesOrderId  String
  invoiceDate   DateTime      @default(now())
  dueDate       DateTime?
  status        InvoiceStatus @default(UNPAID)
  totalAmount   Decimal       @db.Decimal(15, 2)
  paidAmount    Decimal       @default(0) @db.Decimal(15, 2)
  notes         String?
  createdAt     DateTime      @default(now())
  updatedAt     DateTime      @updatedAt

  termOfPaymentDays Int           @default(0)
  salesOrder    SalesOrder    @relation(fields: [salesOrderId], references: [id])

  @@index([salesOrderId])
}

enum SalesOrderType {
  MAKE_TO_STOCK
  MAKE_TO_ORDER
}

enum SalesOrderStatus {
  DRAFT
  CONFIRMED
  IN_PRODUCTION
  READY_TO_SHIP
  SHIPPED
  DELIVERED
  CANCELLED
}

enum InvoiceStatus {
  UNPAID
  PARTIAL
  PAID
  OVERDUE
  CANCELLED
}

// --- Purchasing Module ---

enum PurchaseOrderStatus {
  DRAFT
  SENT
  PARTIAL_RECEIVED
  RECEIVED
  CANCELLED
}

enum PurchaseInvoiceStatus {
  UNPAID
  PARTIAL
  PAID
  OVERDUE
  CANCELLED
}

model PurchaseOrder {
  id               String              @id @default(uuid())
  orderNumber      String              @unique
  supplierId       String
  orderDate        DateTime            @default(now())
  expectedDate     DateTime?
  status           PurchaseOrderStatus @default(DRAFT)
  totalAmount      Decimal?            @db.Decimal(15, 2)
  notes            String?
  createdById      String?
  createdAt        DateTime            @default(now())
  updatedAt        DateTime            @updatedAt

  supplier         Supplier            @relation(fields: [supplierId], references: [id])
  createdBy        User?               @relation("PurchaseCreator", fields: [createdById], references: [id])
  items            PurchaseOrderItem[]
  goodsReceipts    GoodsReceipt[]
  invoices         PurchaseInvoice[]
}

model PurchaseOrderItem {
  id                String         @id @default(uuid())
  purchaseOrderId   String
  productVariantId  String
  quantity          Decimal        @db.Decimal(15, 4)
  unitPrice         Decimal        @db.Decimal(15, 4)
  subtotal          Decimal        @db.Decimal(15, 2)
  receivedQty       Decimal        @default(0) @db.Decimal(15, 4)
  
  purchaseOrder     PurchaseOrder  @relation(fields: [purchaseOrderId], references: [id], onDelete: Cascade)
  productVariant    ProductVariant @relation(fields: [productVariantId], references: [id])
}

model GoodsReceipt {
  id                String             @id @default(uuid())
  receiptNumber     String             @unique
  purchaseOrderId   String
  receivedDate      DateTime           @default(now())
  locationId        String
  notes             String?
  createdById       String?
  createdAt         DateTime           @default(now())

  purchaseOrder     PurchaseOrder      @relation(fields: [purchaseOrderId], references: [id])
  location          Location           @relation(fields: [locationId], references: [id])
  createdBy         User?              @relation("GoodsReceiptCreator", fields: [createdById], references: [id])
  items             GoodsReceiptItem[]
  movements         StockMovement[]   @relation("GoodsReceiptMovement")
}

model GoodsReceiptItem {
  id                String         @id @default(uuid())
  goodsReceiptId    String
  productVariantId  String
  receivedQty       Decimal        @db.Decimal(15, 4)
  unitCost          Decimal        @db.Decimal(15, 4)

  goodsReceipt      GoodsReceipt   @relation(fields: [goodsReceiptId], references: [id], onDelete: Cascade)
  productVariant    ProductVariant @relation(fields: [productVariantId], references: [id])
}

model PurchaseInvoice {
  id               String                @id @default(uuid())
  invoiceNumber    String                @unique
  purchaseOrderId  String
  invoiceDate      DateTime              @default(now())
  dueDate          DateTime?
  status           PurchaseInvoiceStatus @default(UNPAID)
  totalAmount      Decimal               @db.Decimal(15, 2)
  paidAmount       Decimal               @default(0) @db.Decimal(15, 2)
  termOfPaymentDays Int                  @default(0)
  notes            String?
  createdAt        DateTime              @default(now())
  updatedAt        DateTime              @updatedAt

  purchaseOrder    PurchaseOrder         @relation(fields: [purchaseOrderId], references: [id])
  payments         PurchasePayment[]
}

model PurchasePayment {
  id                String          @id @default(uuid())
  purchaseInvoiceId String
  amount            Decimal         @db.Decimal(15, 2)
  paymentDate       DateTime        @default(now())
  paymentMethod     String?
  reference         String?
  notes             String?
  createdById       String?
  createdAt         DateTime        @default(now())

  purchaseInvoice   PurchaseInvoice @relation(fields: [purchaseInvoiceId], references: [id], onDelete: Cascade)
  createdBy         User?           @relation("PaymentCreator", fields: [createdById], references: [id])

  @@index([purchaseInvoiceId])
}

// ============================================
// ACCOUNTING MODELS
// ============================================

model Account {
  id              String       @id @default(uuid())
  code            String       @unique   // e.g., "11310"
  name            String                 // e.g., "Raw Materials"
  description     String?
  type            AccountType            // ASSET, LIABILITY, EQUITY, REVENUE, EXPENSE
  category        AccountCategory        // CURRENT_ASSET, FIXED_ASSET, COGS, etc.
  parentId        String?
  isActive        Boolean      @default(true)
  isCashAccount   Boolean      @default(false) // For cash-flow tracking
  currency        String       @default("IDR")
  createdAt       DateTime     @default(now())
  updatedAt       DateTime     @updatedAt

  parent          Account?     @relation("AccountHierarchy", fields: [parentId], references: [id])
  children        Account[]    @relation("AccountHierarchy")
  journalLines    JournalLine[]
  fixedAssets     FixedAsset[]    @relation("AssetAccount")
  depreciationExpense FixedAsset[] @relation("DeprExpenseAccount")
  accumDepreciation FixedAsset[] @relation("AccumDeprAccount")
  budgets         Budget[]
  
  @@index([code])
  @@index([parentId])
}

model JournalEntry {
  id              String       @id @default(uuid())
  entryNumber     String       @unique   // JE-2026-0001
  entryDate       DateTime
  description     String
  reference       String?                // e.g., "INV-2026-0001", "GR-2026-0001"
  referenceType   ReferenceType?         // SALES_INVOICE, PURCHASE_INVOICE, GOODS_RECEIPT, etc.
  referenceId     String?                // UUID of source document
  status          JournalStatus @default(DRAFT)
  isAutoGenerated Boolean      @default(false)
  createdById     String?
  approvedById    String?
  approvedAt      DateTime?
  createdAt       DateTime     @default(now())
  updatedAt       DateTime     @updatedAt

  createdBy       User?        @relation("JournalCreator", fields: [createdById], references: [id])
  approvedBy      User?        @relation("JournalApprover", fields: [approvedById], references: [id])
  lines           JournalLine[]

  @@index([entryDate])
  @@index([referenceType, referenceId])
}

model JournalLine {
  id              String       @id @default(uuid())
  journalEntryId  String
  accountId       String
  description     String?
  debit           Decimal      @default(0) @db.Decimal(15, 2)
  credit          Decimal      @default(0) @db.Decimal(15, 2)
  currency        String       @default("IDR")
  exchangeRate    Decimal      @default(1) @db.Decimal(15, 6)
  createdAt       DateTime     @default(now())

  journalEntry    JournalEntry @relation(fields: [journalEntryId], references: [id], onDelete: Cascade)
  account         Account      @relation(fields: [accountId], references: [id])

  @@index([journalEntryId])
  @@index([accountId])
}

model FiscalPeriod {
  id              String       @id @default(uuid())
  name            String                 // e.g., "January 2026"
  startDate       DateTime
  endDate         DateTime
  year            Int
  month           Int
  status          PeriodStatus @default(OPEN)
  closedById      String?
  closedAt        DateTime?

  @@unique([year, month])
}

// Enums

enum AccountType {
  ASSET
  LIABILITY
  EQUITY
  REVENUE
  EXPENSE
}

enum AccountCategory {
  // Assets
  CURRENT_ASSET
  FIXED_ASSET
  OTHER_ASSET
  // Liabilities
  CURRENT_LIABILITY
  LONG_TERM_LIABILITY
  // Equity
  CAPITAL
  RETAINED_EARNINGS
  // Revenue
  OPERATING_REVENUE
  OTHER_REVENUE
  // Expenses
  COGS
  OPERATING_EXPENSE
  OTHER_EXPENSE
}

enum ReferenceType {
  SALES_INVOICE
  SALES_PAYMENT
  PURCHASE_INVOICE
  PURCHASE_PAYMENT
  GOODS_RECEIPT
  STOCK_ADJUSTMENT
  PRODUCTION_OUTPUT
  MATERIAL_ISSUE
  MANUAL_ENTRY
}

enum JournalStatus {
  DRAFT
  POSTED
  VOIDED
}

enum PeriodStatus {
  OPEN
  CLOSED
  LOCKED
}
enum AssetStatus {
  ACTIVE
  FULLY_DEPRECIATED
  DISPOSED
  MAINTENANCE
}

model FixedAsset {
  id                               String      @id @default(uuid())
  assetCode                        String      @unique
  name                             String
  category                         String
  purchaseDate                     DateTime
  purchaseValue                    Decimal     @db.Decimal(15, 2)
  scrapValue                       Decimal     @default(0) @db.Decimal(15, 2)
  usefulLifeMonths                 Int
  depreciationMethod               String      @default("STRAIGHT_LINE")
  
  // GL Accounts
  assetAccountId                   String
  assetAccount                     Account     @relation("AssetAccount", fields: [assetAccountId], references: [id])
  depreciationAccountId            String
  depreciationExpenseAccount      Account     @relation("DeprExpenseAccount", fields: [depreciationAccountId], references: [id])
  accumulatedDepreciationAccountId String
  accumDepreciationAccount         Account     @relation("AccumDeprAccount", fields: [accumulatedDepreciationAccountId], references: [id])

  status                           AssetStatus @default(ACTIVE)
  locationId                       String?
  location                         Location?   @relation(fields: [locationId], references: [id])
  
  lastDepreciationDate             DateTime?
  
  createdAt                        DateTime    @default(now())
  updatedAt                        DateTime    @updatedAt
}

model Budget {
  id        String   @id @default(uuid())
  accountId String
  account   Account  @relation(fields: [accountId], references: [id])
  year      Int
  month     Int
  amount    Decimal  @db.Decimal(15, 2)
  
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([accountId, year, month])
}

